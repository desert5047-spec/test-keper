---
description: Next.js App RouterとSupabase Authの統合パターンとベストプラクティス
globs: **/lib/supabase/**/*.ts,**/app/**/*.tsx,**/app/**/*.ts
alwaysApply: false
---

# Next.js App Router + Supabase Auth 統合ルール

このルールは、[Supabase公式ドキュメント](https://supabase.com/docs/guides/auth/server-side/creating-a-client?queryGroups=framework&framework=nextjs)に基づいたNext.js App RouterとSupabase Authの統合パターンを定義します。

## パッケージのインストール

```bash
npm install @supabase/supabase-js @supabase/ssr
```

## 環境変数

`.env.local`に以下を設定：

```env
NEXT_PUBLIC_SUPABASE_URL=your_project_url
NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY=your_publishable_key
```

**注意**: 新しいAPIキー形式（`sb_publishable_xxx`）を使用。従来の`anon`キーは非推奨。

## クライアントの作成

### Client Component用クライアント

`lib/supabase/client.ts`:

```typescript
import { createBrowserClient } from '@supabase/ssr'

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!
  )
}
```

### Server Component用クライアント

`lib/supabase/server.ts`:

```typescript
import { createServerClient } from '@supabase/ssr'
import { cookies } from 'next/headers'

export async function createClient() {
  const cookieStore = await cookies()

  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll()
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            )
          } catch {
            // Server Componentでのcookie設定は無視
          }
        },
      },
    }
  )
}
```

## セキュリティのベストプラクティス

### ❌ 避けるべきこと

```typescript
// Server ComponentでgetSession()を信用しない
const { data: { session } } = await supabase.auth.getSession()
if (session) {
  // 危険: セッションが改ざんされている可能性がある
}
```

### ✅ 推奨される方法

```typescript
// getClaims()を使用してJWT署名を検証
const { data: { user } } = await supabase.auth.getUser()
if (user) {
  // 安全: JWT署名が検証されている
}
```

## Proxyの設定

`lib/supabase/proxy.ts`:

```typescript
import { type NextRequest, NextResponse } from 'next/server'
import { createServerClient } from '@supabase/ssr'

export async function updateSession(request: NextRequest) {
  let supabaseResponse = NextResponse.next({
    request,
  })

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll()
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value, options }) => request.cookies.set(name, value))
          supabaseResponse = NextResponse.next({
            request,
          })
          cookiesToSet.forEach(({ name, value, options }) =>
            supabaseResponse.cookies.set(name, value, options)
          )
        },
      },
    }
  )

  // トークンをリフレッシュ（getClaims()で検証）
  await supabase.auth.getUser()

  return supabaseResponse
}
```

`middleware.ts`:

```typescript
import { type NextRequest } from 'next/server'
import { updateSession } from '@/lib/supabase/proxy'

export async function middleware(request: NextRequest) {
  return await updateSession(request)
}

export const config = {
  matcher: [
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
  ],
}
```

## 使用例

### Server Component

```typescript
import { createClient } from '@/lib/supabase/server'

export default async function Page() {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()
  
  if (!user) {
    redirect('/login')
  }
  
  return <div>Hello {user.email}</div>
}
```

### Client Component

```typescript
'use client'
import { createClient } from '@/lib/supabase/client'
import { useEffect, useState } from 'react'

export default function ClientComponent() {
  const supabase = createClient()
  const [user, setUser] = useState(null)

  useEffect(() => {
    supabase.auth.getUser().then(({ data: { user } }) => {
      setUser(user)
    })
  }, [])

  return <div>{user?.email}</div>
}
```

### Server Action

```typescript
'use server'
import { createClient } from '@/lib/supabase/server'
import { revalidatePath } from 'next/cache'

export async function updateProfile(formData: FormData) {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()
  
  if (!user) {
    throw new Error('Unauthorized')
  }
  
  // プロフィール更新処理
  revalidatePath('/profile')
}
```

## 重要な注意事項

1. **Cookieの扱い**: Server Componentでは`cookies()`を`await`する必要がある（Next.js 15+）
2. **セッション検証**: サーバー側では常に`getUser()`または`getClaims()`を使用
3. **Proxyの役割**: トークンリフレッシュとCookie同期を自動化
4. **型安全性**: TypeScriptの型定義を`generate_typescript_types`で生成
